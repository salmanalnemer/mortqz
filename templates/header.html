{% load static %}
<!-- header.html (Light Modern) -->
<style>
  .site-header{
    direction: rtl;
    font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
    color: var(--text, #213448);
  }
  .site-header a{ color: inherit; text-decoration: none; }
  .site-header .wrap{ max-width: 1200px; margin: 0 auto; padding: 0 16px; }

  /* Top strip */
  .top-strip{
    background: linear-gradient(90deg, #134181, #134181);
    border-bottom: 1px solid var(--border, #ffffff);
  }
  .top-row{
    display:flex; align-items:center; justify-content:space-between;
    gap: 12px; flex-wrap: wrap;
    padding: 10px 0;
  }
  .top-left, .top-right{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(33,52,72,.10);
    background: rgba(255,255,255,.70);
    font-size: 13px;
    color: rgba(33,52,72,.90);
    box-shadow: 0 4px 10px rgba(33,52,72,.06);
  }
  .mini-link{
    font-size: 13px;
    color: rgba(33,52,72,.80);
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(33,52,72,.08);
    background: rgba(255,255,255,.55);
  }
  .mini-link:hover{ background: rgba(255,255,255,.85); }

  /* Main */
  .main-bar{
    background: rgba(255,255,255,.92);
    border-bottom: 1px solid var(--border, #E6EEF4);
    position: sticky; top:0; z-index: 50;
    backdrop-filter: blur(10px);
  }
  .main-bar.is-scrolled{ box-shadow: 0 6px 16px rgba(33,52,72,.08); }

  .main-row{
    display:grid;
    grid-template-columns: 240px 1fr 280px;
    align-items:center;
    gap: 14px;
    padding: 14px 0;
  }

  /* Brand */
  .brand{ display:flex; align-items:center; gap: 10px; min-width:0; }
  .logo{
    width: 42px; height: 42px; border-radius: 14px;
    background: linear-gradient(135deg, var(--c2,#547792), var(--c3,#94B4C1));
    box-shadow: 0 10px 20px rgba(84,119,146,.18);
    position: relative; overflow:hidden;
    flex: 0 0 auto;
  }
  .logo:before{
    content:""; position:absolute; inset:-35%;
    background: radial-gradient(circle at 30% 30%, rgba(234,224,207,.90), transparent 55%);
    transform: rotate(12deg);
    opacity:.9;
  }
  .brand-title{ line-height: 1.15; min-width:0; }
  .brand-title .name{ font-weight: 1000; font-size: 16px; }
  .brand-title .tag{
    font-size: 12px;
    color: var(--muted,#5B7284);
    margin-top: 2px;
    white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    max-width: 220px;
  }

  /* Search */
  .search{
    display:flex; align-items:center; gap: 10px;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid var(--border,#E6EEF4);
    background: var(--surface,#fff);
    box-shadow: 0 8px 18px rgba(33,52,72,.06);
  }
  .search input{
    width: 100%;
    background: transparent;
    border:0; outline:0;
    color: var(--text,#213448);
    font-size: 14px;
  }
  .search input::placeholder{ color: rgba(91,114,132,.80); }
  .search .btn{
    border:0; cursor:pointer;
    padding: 10px 12px;
    border-radius: 999px;
    background: linear-gradient(135deg, var(--c2,#547792), var(--c3,#94B4C1));
    color: #fff;
    font-weight: 1000;
    box-shadow: 0 10px 18px rgba(84,119,146,.18);
  }
  .search .btn:hover{ filter: brightness(1.03); }

  /* Actions */
  .actions{
    display:flex; align-items:center; justify-content:flex-end;
    gap: 10px; flex-wrap: wrap;
  }
  .icon-btn{
    display:inline-flex; align-items:center; gap: 10px;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid var(--border,#E6EEF4);
    background: var(--surface,#fff);
    cursor:pointer;
    color: rgba(33,52,72,.92);
    box-shadow: 0 8px 16px rgba(33,52,72,.05);
    user-select:none;
  }
  .icon-btn:hover{ box-shadow: 0 10px 18px rgba(33,52,72,.08); }
  .icon-btn .title{ font-size: 13px; font-weight: 1000; }
  .badge{
    min-width: 20px; height: 20px;
    padding: 0 6px;
    border-radius: 999px;
    display:inline-flex; align-items:center; justify-content:center;
    background: rgba(234,224,207,.90);
    color: var(--c1,#213448);
    font-weight: 1000;
    font-size: 12px;
    margin-inline-start: 6px;
    border: 1px solid rgba(33,52,72,.10);
  }

  /* Nav */
  .nav{ padding: 0 0 14px; }
  .nav-row{
    display:flex; align-items:center; justify-content:space-between;
    gap: 12px; flex-wrap: wrap;
  }
  .nav-links{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
  .nav-links a{
    padding: 9px 12px;
    border-radius: 999px;
    border: 1px solid var(--border,#E6EEF4);
    background: var(--surface2,#F1F5F9);
    color: rgba(33,52,72,.88);
    font-size: 13px;
  }
  .nav-links a:hover{ background: #fff; }
  .nav-links a.is-hot{
    background: linear-gradient(135deg, rgba(148,180,193,.55), rgba(234,224,207,.70));
    border-color: rgba(84,119,146,.18);
    font-weight: 1000;
  }

  /* Mobile */
  .mobile-toggle{
    display:none;
    align-items:center; gap:10px;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid var(--border,#E6EEF4);
    background: var(--surface,#fff);
    cursor:pointer;
    box-shadow: 0 8px 16px rgba(33,52,72,.05);
  }
  .mobile-panel{
    margin-top: 10px;
    border-radius: 16px;
    border: 1px solid var(--border,#E6EEF4);
    background: rgba(255,255,255,.95);
    padding: 10px;
    box-shadow: 0 10px 18px rgba(33,52,72,.08);
  }
  .mobile-panel[hidden]{ display:none; }

  /* Toast */
  .toast{
    position: fixed;
    bottom: 18px;
    inset-inline-end: 18px;
    max-width: 340px;
    background: rgba(255,255,255,.96);
    border: 1px solid var(--border,#E6EEF4);
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(33,52,72,.10);
    padding: 12px;
    display:flex; gap: 10px; align-items:flex-start;
    transform: translateY(10px);
    opacity: 0;
    pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
    z-index: 9999;
  }
  .toast.show{ opacity: 1; transform: translateY(0); pointer-events:auto; }
  .toast .t-title{ font-weight: 1000; font-size: 13px; }
  .toast .t-msg{ font-size: 12px; color: var(--muted,#5B7284); margin-top: 2px; line-height: 1.6; }
  .toast .t-x{
    margin-inline-start:auto;
    border:0; background: transparent;
    cursor:pointer;
    color: rgba(33,52,72,.65);
    padding: 4px 6px;
    border-radius: 10px;
  }
  .toast .t-x:hover{ background: rgba(148,180,193,.20); }

  @media (max-width: 980px){
    .main-row{ grid-template-columns: 1fr; }
    .actions{ justify-content: space-between; }
    .brand{ justify-content: space-between; }
    .mobile-toggle{ display:inline-flex; }
    .nav-row{ display:none; }
  }
  @media (max-width: 520px){
    .toast{ inset-inline: 12px; bottom: 12px; max-width: none; }
  }
</style>

<header class="site-header">
  <div class="top-strip">
    <div class="wrap">
      <div class="top-row">
        <div class="top-left">
          <span class="chip">شحن سريع + تغليف آمن</span>
          <a class="mini-link" href="#" data-action="track">تتبّع الطلب</a>
          <a class="mini-link" href="#featured">عروض اليوم</a>
        </div>
        <div class="top-right">
          <div class="top-right">

            {% if request.user.is_authenticated %}
              <!-- ✅ ترحيب باسم المستخدم من الجلسة -->
              <span class="chip">
                مرحباً،
                {{ request.user.get_full_name|default:request.user.username }}
              </span>

              <!-- ✅ زر تسجيل خروج -->
              <form action="{% url 'accounts:logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="mini-link" style="cursor:pointer;">تسجيل خروج</button>
              </form>
            {% else %}
              <a class="mini-link" href="{% url 'accounts:login' %}" data-action="login">تسجيل الدخول</a>
              <a class="mini-link" href="{% url 'accounts:signup' %}" data-action="signup">حساب جديد</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-bar" id="mainHeader">
    <div class="wrap">
      <div class="main-row">
        <div class="brand">
          <a href="#" class="brand" aria-label="الرئيسية">
            <span class="logo" aria-hidden="true"></span>
            <span class="brand-title">
              <div class="name">متجر مرتكز التقنية</div>
              <div class="tag">منتجات أصلية • أسعار منافسة</div>
            </span>
          </a>

          <button class="mobile-toggle" id="mobileToggle" type="button" aria-label="فتح القائمة">القائمة</button>
        </div>

        <form class="search" id="searchForm" action="#" method="get" role="search" aria-label="بحث">
          <input id="q" name="q" type="search" placeholder="ابحث عن: لابتوب، سماعات، شاحن..." autocomplete="off" />
          <button class="btn" type="submit">بحث</button>
        </form>

        <div class="actions">
          <!-- ✅ اسم المستخدم داخل الهيدر بجانب (حسابي) -->
          <a class="icon-btn" href="#" data-action="account">
            <span class="title">حسابي</span>
            {% if request.user.is_authenticated %}
              <span class="badge" style="min-width:auto;height:auto;padding:2px 8px;line-height:1.6;">
                {{ request.user.get_full_name|default:request.user.username }}
              </span>
            {% endif %}
          </a>

          <button class="icon-btn" type="button" id="favBtn" aria-pressed="false">
            <span class="title">المفضلة</span>
            <span class="badge" id="favCount">0</span>
          </button>

          <a class="icon-btn" href="#" data-action="cart">
            <span class="title">السلة</span>
            <span class="badge" id="cartCountBadge">0</span>
          </a>
        </div>
      </div>

      <div class="nav">
        <div class="nav-row">
          <div class="nav-links">
            <a href="#featured" class="is-hot">خصومات اليوم</a>
            <a href="#categories">الأقسام</a>
            <a href="#">لابتوبات</a>
            <a href="#">جوالات</a>
            <a href="#">سماعات</a>
            <a href="#">إكسسوارات</a>
            <a href="#">منزل ذكي</a>
          </div>
          <div class="nav-links">
            <a href="#" data-action="support">الدعم</a>
            <a href="#" data-action="policy">الضمان والاستبدال</a>
          </div>
        </div>

        <div class="mobile-panel" id="mobilePanel" hidden>
          <div class="nav-links" style="margin-bottom:10px;">
            <a href="#featured" class="is-hot">خصومات اليوم</a>
            <a href="#categories">الأقسام</a>
            <a href="#">لابتوبات</a>
            <a href="#">جوالات</a>
            <a href="#">سماعات</a>
            <a href="#">إكسسوارات</a>
            <a href="#">منزل ذكي</a>
          </div>
          <div class="nav-links">
            <a href="#" data-action="support">الدعم</a>
            <a href="#" data-action="policy">الضمان والاستبدال</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true">
    <div>
      <div class="t-title" id="toastTitle">تم</div>
      <div class="t-msg" id="toastMsg">...</div>
    </div>
    <button class="t-x" type="button" id="toastClose" aria-label="إغلاق">✕</button>
  </div>
</header>

<script>
  (function(){
    const header = document.getElementById('mainHeader');
    const toggle = document.getElementById('mobileToggle');
    const panel  = document.getElementById('mobilePanel');

    const cartBadge = document.getElementById('cartCountBadge');
    const favBtn = document.getElementById('favBtn');
    const favCount = document.getElementById('favCount');

    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMsg = document.getElementById('toastMsg');
    const toastClose = document.getElementById('toastClose');
    let toastTimer = null;

    function safeInt(v){
      const n = parseInt(v, 10);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    }

    function syncBadges(){
      if(cartBadge) cartBadge.textContent = String(safeInt(localStorage.getItem('cart_count')));
      if(favCount) favCount.textContent = String(safeInt(localStorage.getItem('fav_count')));
    }

    function toastShow(title, msg){
      if(!toast) return;
      toastTitle.textContent = title || 'تنبيه';
      toastMsg.textContent = msg || '';
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 2200);
    }

    // expose toast to pages (home.html can call it)
    window.appToast = toastShow;

    if(toastClose){
      toastClose.addEventListener('click', () => toast.classList.remove('show'));
    }

    function onScroll(){
      if(!header) return;
      header.classList.toggle('is-scrolled', window.scrollY > 8);
    }
    window.addEventListener('scroll', onScroll, {passive:true});
    onScroll();

    if(toggle && panel){
      toggle.addEventListener('click', () => {
        const hidden = panel.hasAttribute('hidden');
        hidden ? panel.removeAttribute('hidden') : panel.setAttribute('hidden','');
      });
    }

    const searchForm = document.getElementById('searchForm');
    if(searchForm){
      searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const q = document.getElementById('q')?.value?.trim();
        if(!q) return toastShow('البحث', 'اكتب كلمة البحث أولاً');
        toastShow('البحث', 'جاري البحث عن: ' + q);
      });
    }

    document.querySelectorAll('[data-action]').forEach(el=>{
      el.addEventListener('click',(e)=>{
        const a = el.getAttribute('data-action') || '';

        // ✅ لا تمنع تنقّل صفحات الدخول/التسجيل (اتركها تفتح الروابط)
        if(a !== 'cart' && a !== 'login' && a !== 'signup'){
          e.preventDefault();
          toastShow('تنبيه', 'زر ('+a+') جاهز — اربطه بالباكند لاحقاً');
        }
      });
    });

    if(favBtn){
      favBtn.addEventListener('click', ()=>{
        const cur = safeInt(localStorage.getItem('fav_count'));
        const next = cur === 0 ? 1 : 0;
        localStorage.setItem('fav_count', String(next));
        favBtn.setAttribute('aria-pressed', next > 0 ? 'true' : 'false');
        syncBadges();
        toastShow('المفضلة', next > 0 ? 'تمت الإضافة ✅' : 'تمت الإزالة');
        window.dispatchEvent(new Event('fav:updated'));
      });
    }

    window.addEventListener('storage', (e)=>{
      if(e.key === 'cart_count' || e.key === 'fav_count') syncBadges();
    });
    window.addEventListener('cart:updated', syncBadges);
    window.addEventListener('fav:updated', syncBadges);

    // ✅ إجبار التنقّل لصفحات الدخول/التسجيل (يتجاوز preventDefault)
    function forceNavigate(selector){
      const el = document.querySelector(selector);
      if(!el) return;

      el.addEventListener('click', function(e){
        const href = (this.getAttribute('href') || '').trim();
        if(!href || href === '#') return;
        e.stopPropagation();
      }, true); // capture=true
    }

    forceNavigate('[data-action="login"]');
    forceNavigate('[data-action="signup"]');

    syncBadges();
  })();
</script>
