{% load static %}
<!-- header.html (Noon-like RTL - NEW DESIGN) -->

<style>
  :root{
    --bg:#ffffff;
    --soft:#f5f6f7;
    --soft2:#f0f2f5;
    --line:#e6e8eb;

    --text:#101820;
    --muted:#6b7280;

    /* Noon vibe */
    --noon:#ffd400;       /* primary */
    --noon2:#111827;      /* dark */
    --accent:#2563eb;     /* link accent */

    --radius:16px;
    --shadow: 0 10px 28px rgba(16,24,32,.10);
  }

  .site-header{
    direction: rtl;
    font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
    color: var(--text);
    background: var(--bg);
  }
  .site-header a{ color: inherit; text-decoration:none; }
  .site-header .wrap{ max-width: 1200px; margin:0 auto; padding: 0 16px; }

  /* ===== Top thin bar ===== */
  .topbar{
    background: #fff;
    border-bottom: 1px solid var(--line);
    font-size: 12.5px;
    color: rgba(16,24,32,.88);
  }
  .topbar-row{
    display:flex; align-items:center; justify-content:space-between;
    gap: 10px; flex-wrap:wrap;
    padding: 8px 0;
  }
  .top-links, .top-auth{
    display:flex; align-items:center; gap: 10px; flex-wrap:wrap;
  }
  .top-link{
    color: rgba(16,24,32,.86);
    padding: 4px 8px;
    border-radius: 10px;
  }
  .top-link:hover{ background: var(--soft); }
  .top-pill{
    display:inline-flex; align-items:center; gap: 8px;
    padding: 4px 10px;
    border-radius: 999px;
    background: var(--soft);
    border: 1px solid var(--line);
    white-space:nowrap;
  }
  .top-btn{
    appearance:none;
    border: 1px solid var(--line);
    background: #fff;
    color: rgba(16,24,32,.88);
    padding: 5px 10px;
    border-radius: 10px;
    cursor:pointer;
  }
  .top-btn:hover{ background: var(--soft); }

  /* ===== Main bar (Yellow like noon) ===== */
  .mainbar{
    background: var(--noon);
    border-bottom: 1px solid rgba(0,0,0,.06);
    position: sticky;
    top: 0;
    z-index: 60;
  }
  .mainbar.is-scrolled{ box-shadow: var(--shadow); }

  .main-row{
    display:grid;
    grid-template-columns: 220px 1fr 320px;
    gap: 12px;
    align-items:center;
    padding: 12px 0;
  }

  /* Brand */
  .brand{
    display:flex; align-items:center; gap: 10px;
    min-width: 0;
  }
  .brand-badge{
    width: 44px; height: 44px;
    border-radius: 14px;
    background: #fff;
    border: 1px solid rgba(0,0,0,.08);
    display:flex; align-items:center; justify-content:center;
    font-weight: 1000;
    color: #111;
    flex:0 0 auto;
    box-shadow: 0 8px 18px rgba(0,0,0,.10);
  }
  .brand-text{ min-width:0; line-height:1.1; }
  .brand-name{
    font-weight: 1000;
    font-size: 15px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 160px;
  }
  .brand-tag{
    margin-top: 4px;
    font-size: 12px;
    color: rgba(0,0,0,.65);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 180px;
  }

  /* Search */
  .search{
    display:flex;
    align-items:center;
    gap: 8px;
    background: #fff;
    border-radius: 999px;
    padding: 8px 10px;
    border: 1px solid rgba(0,0,0,.10);
    box-shadow: 0 10px 22px rgba(0,0,0,.10);
  }
  .search .icon{
    width: 34px; height: 34px;
    border-radius: 999px;
    background: var(--soft);
    border: 1px solid var(--line);
    display:flex; align-items:center; justify-content:center;
    flex:0 0 auto;
    color: rgba(16,24,32,.88);
  }
  .search input{
    flex: 1;
    border:0;
    outline:0;
    background: transparent;
    font-size: 14px;
    color: var(--text);
    padding: 6px 6px;
  }
  .search input::placeholder{ color: rgba(107,114,128,.92); }
  .search button{
    border:0;
    cursor:pointer;
    border-radius: 999px;
    padding: 10px 14px;
    background: var(--noon2);
    color:#fff;
    font-weight: 1000;
  }
  .search button:hover{ filter: brightness(1.05); }

  /* Actions */
  .actions{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap: 10px;
    flex-wrap:wrap;
  }
  .act{
    display:inline-flex;
    align-items:center;
    gap: 10px;
    padding: 9px 10px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.92);
    cursor:pointer;
    user-select:none;
    transition:.18s ease;
  }
  .act:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,.12); }
  .act .ico{
    width: 36px; height: 36px;
    border-radius: 12px;
    background: var(--soft);
    border: 1px solid var(--line);
    display:flex; align-items:center; justify-content:center;
    flex:0 0 auto;
  }
  .act .lbl{ line-height:1.1; }
  .act .t1{ font-size: 12px; font-weight: 1000; }
  .act .t2{
    margin-top: 3px;
    font-size: 12px;
    color: rgba(0,0,0,.62);
    max-width: 140px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .badge{
    min-width: 22px;
    height: 22px;
    padding: 0 7px;
    border-radius: 999px;
    background: #fff;
    border: 1px solid rgba(0,0,0,.12);
    color: #111;
    font-weight: 1000;
    font-size: 12px;
    display:inline-flex; align-items:center; justify-content:center;
    margin-inline-start: 4px;
  }

  /* ===== Categories bar (horizontal scroll like noon) ===== */
  .cats{
    background: #fff;
    border-bottom: 1px solid var(--line);
  }
  .cats-row{
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 10px 0;
  }
  .cats-btn{
    display:inline-flex;
    align-items:center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid var(--line);
    background: var(--soft);
    cursor:pointer;
    font-weight: 900;
    white-space:nowrap;
  }
  .cats-btn:hover{ background: var(--soft2); }
  .cats-scroll{
    display:flex;
    gap: 8px;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    padding-bottom: 2px;
    flex: 1;
  }
  .cats-scroll::-webkit-scrollbar{ height: 8px; }
  .cats-scroll::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.12); border-radius: 999px; }
  .cat{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: #fff;
    font-size: 13px;
    white-space:nowrap;
    transition:.18s ease;
  }
  .cat:hover{ background: var(--soft); }
  .cat.hot{
    border-color: rgba(0,0,0,.16);
    background: rgba(255,212,0,.25);
    font-weight: 1000;
  }

  /* ===== Drawer for mobile categories ===== */
  .drawer-backdrop{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.35);
    opacity: 0;
    pointer-events:none;
    transition: opacity .18s ease;
    z-index: 9990;
  }
  .drawer-backdrop.show{ opacity: 1; pointer-events:auto; }
  .drawer{
    position: fixed;
    top: 0;
    inset-inline-start: 0;
    height: 100%;
    width: min(360px, 86vw);
    background: #fff;
    transform: translateX(110%);
    transition: transform .22s ease;
    z-index: 9991;
    box-shadow: -20px 0 40px rgba(0,0,0,.18);
    display:flex;
    flex-direction:column;
  }
  .drawer.show{ transform: translateX(0); }
  .drawer-head{
    padding: 14px 14px;
    border-bottom: 1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .drawer-title{
    font-weight: 1000;
    font-size: 14px;
  }
  .drawer-close{
    border: 1px solid var(--line);
    background: var(--soft);
    cursor:pointer;
    border-radius: 12px;
    padding: 8px 10px;
    font-weight: 900;
  }
  .drawer-body{
    padding: 12px 14px;
    overflow:auto;
  }
  .drawer-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .drawer-item{
    border: 1px solid var(--line);
    background: #fff;
    border-radius: 14px;
    padding: 12px 12px;
    font-size: 13px;
  }
  .drawer-item:hover{ background: var(--soft); }

  /* ===== Bottom nav (mobile) ===== */
  .bottom-nav{
    display:none;
    position: fixed;
    bottom: 0;
    inset-inline: 0;
    background: #fff;
    border-top: 1px solid var(--line);
    z-index: 9992;
  }
  .bottom-row{
    max-width: 1200px;
    margin: 0 auto;
    padding: 8px 12px;
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }
  .b-item{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 6px;
    padding: 8px 8px;
    border-radius: 12px;
    border: 1px solid transparent;
    color: rgba(16,24,32,.92);
  }
  .b-item:hover{ background: var(--soft); border-color: var(--line); }
  .b-ico{
    width: 34px; height: 34px;
    border-radius: 12px;
    background: var(--soft);
    border: 1px solid var(--line);
    display:flex; align-items:center; justify-content:center;
  }
  .b-txt{ font-size: 12px; font-weight: 900; }

  /* Toast */
  .toast{
    position: fixed;
    bottom: 78px; /* above bottom nav */
    inset-inline-end: 18px;
    max-width: 360px;
    background: rgba(255,255,255,.98);
    border: 1px solid var(--line);
    border-radius: 14px;
    box-shadow: 0 16px 34px rgba(16,24,32,.12);
    padding: 12px 12px;
    display:flex;
    gap: 10px;
    align-items:flex-start;
    transform: translateY(10px);
    opacity: 0;
    pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
    z-index: 9999;
  }
  .toast.show{ opacity:1; transform: translateY(0); pointer-events:auto; }
  .toast .t-title{ font-weight: 1000; font-size: 13px; }
  .toast .t-msg{ font-size: 12px; color: var(--muted); margin-top: 2px; line-height: 1.6; }
  .toast .t-x{
    margin-inline-start:auto;
    border:0;
    background: transparent;
    cursor:pointer;
    color: rgba(107,114,128,.95);
    padding: 4px 6px;
    border-radius: 10px;
  }
  .toast .t-x:hover{ background: rgba(0,0,0,.06); }

  /* Responsive */
  @media (max-width: 980px){
    .main-row{ grid-template-columns: 1fr; }
    .actions{ justify-content: space-between; }
    .brand-badge{ box-shadow:none; }
  }
  @media (max-width: 760px){
    .topbar{ display:none; } /* noon Ø¹Ø§Ø¯Ø© ÙŠØ®ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    .cats{ display:none; }   /* Ù†Ø³ØªØ®Ø¯Ù… drawer + bottom nav */
    .bottom-nav{ display:block; }
    .toast{ bottom: 86px; inset-inline: 12px; max-width:none; }
  }
</style>

<header class="site-header">

  <!-- Thin top bar -->
  <div class="topbar">
    <div class="wrap">
      <div class="topbar-row">
        <div class="top-links">
          <a class="top-link" href="#featured">Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙŠÙˆÙ…</a>
          <a class="top-link" href="#categories">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
          <a class="top-link" href="#" data-action="support">Ø§Ù„Ø¯Ø¹Ù…</a>
          <a class="top-link" href="#" data-action="policy">Ø§Ù„Ø¶Ù…Ø§Ù† ÙˆØ§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</a>
          <span class="top-pill">Ø´Ø­Ù† Ø³Ø±ÙŠØ¹ â€¢ Ø¯ÙØ¹ Ø¢Ù…Ù†</span>
        </div>

        <div class="top-auth">
          {% if request.user.is_authenticated %}
            <span class="top-pill">
              Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {{ request.user.get_full_name|default:request.user.username }}
            </span>
            <form action="{% url 'accounts:logout' %}" method="post" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="top-btn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </form>
          {% else %}
            <a class="top-link" href="{% url 'accounts:login' %}" data-action="login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
            <a class="top-link" href="{% url 'accounts:signup' %}" data-action="signup">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Main yellow bar -->
  <div class="mainbar" id="mainHeader">
    <div class="wrap">
      <div class="main-row">

        <div class="brand">
          <a href="{% url 'orders:home' %}" class="brand" aria-label="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
            <span class="brand-badge">M</span>
            <span class="brand-text">
              <div class="brand-name">Ù…Ø±ØªÙƒØ²</div>
              <div class="brand-tag">tech store</div>
            </span>
          </a>
        </div>

        <form class="search" id="searchForm" action="#" method="get" role="search" aria-label="Ø¨Ø­Ø«">
          <span class="icon" aria-hidden="true">ğŸ”</span>
          <input id="q" name="q" type="search" placeholder="ÙˆØ´ ØªØ¨ÙŠ ØªØ´ØªØ±ÙŠ Ø§Ù„ÙŠÙˆÙ…ØŸ" autocomplete="off" />
          <button type="submit">Ø¨Ø­Ø«</button>
        </form>

        <div class="actions">
          <a class="act" href="#" data-action="account" aria-label="Ø­Ø³Ø§Ø¨ÙŠ">
            <span class="ico">ğŸ‘¤</span>
            <span class="lbl">
              <div class="t1">Ø­Ø³Ø§Ø¨ÙŠ</div>
              {% if request.user.is_authenticated %}
                <div class="t2">{{ request.user.get_full_name|default:request.user.username }}</div>
              {% else %}
                <div class="t2">ØªØ³Ø¬ÙŠÙ„ / Ø­Ø³Ø§Ø¨</div>
              {% endif %}
            </span>
          </a>

          <button class="act" type="button" id="favBtn" aria-pressed="false" aria-label="Ø§Ù„Ù…ÙØ¶Ù„Ø©">
            <span class="ico">â¤</span>
            <span class="lbl">
              <div class="t1">Ø§Ù„Ù…ÙØ¶Ù„Ø©</div>
              <div class="t2">Ø§Ù„Ø¹Ù†Ø§ØµØ± <span class="badge" id="favCount">0</span></div>
            </span>
          </button>

          <a class="act" href="{% url 'orders:cart_detail' %}" data-action="cart" aria-label="Ø§Ù„Ø³Ù„Ø©">
            <span class="ico">ğŸ›’</span>
            <span class="lbl">
              <div class="t1">Ø§Ù„Ø³Ù„Ø©</div>
              <div class="t2">Ø§Ù„Ø¹Ù†Ø§ØµØ± <span class="badge" id="cartCountBadge">0</span></div>
            </span>
          </a>
        </div>

      </div>
    </div>
  </div>

  <!-- Categories scroll bar (desktop/tablet) -->
  <div class="cats">
    <div class="wrap">
      <div class="cats-row">
        <button class="cats-btn" type="button" id="catsDrawerBtn">â˜° ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>

        <div class="cats-scroll" aria-label="Ø§Ù„Ø£Ù‚Ø³Ø§Ù…">
          <a class="cat hot" href="#featured">Ø®ØµÙˆÙ…Ø§Øª</a>
          <a class="cat" href="#categories">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
          <a class="cat" href="#">Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª</a>
          <a class="cat" href="#">Ø¬ÙˆØ§Ù„Ø§Øª</a>
          <a class="cat" href="#">Ø³Ù…Ø§Ø¹Ø§Øª</a>
          <a class="cat" href="#">Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</a>
          <a class="cat" href="#">Ù…Ù†Ø²Ù„ Ø°ÙƒÙŠ</a>
          <a class="cat" href="#">Ø´Ø§Ø´Ø§Øª</a>
          <a class="cat" href="#">Ø·Ø§Ø¨Ø¹Ø§Øª</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" id="drawerBackdrop" hidden></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div class="drawer-title">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
      <button class="drawer-close" type="button" id="drawerClose">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="drawer-body">
      <div class="drawer-grid">
        <a class="drawer-item" href="#">Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª</a>
        <a class="drawer-item" href="#">Ø¬ÙˆØ§Ù„Ø§Øª</a>
        <a class="drawer-item" href="#">Ø³Ù…Ø§Ø¹Ø§Øª</a>
        <a class="drawer-item" href="#">Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</a>
        <a class="drawer-item" href="#">Ù…Ù†Ø²Ù„ Ø°ÙƒÙŠ</a>
        <a class="drawer-item" href="#">Ø´Ø§Ø´Ø§Øª</a>
        <a class="drawer-item" href="#">Ø·Ø§Ø¨Ø¹Ø§Øª</a>
        <a class="drawer-item" href="#">Ø£Ù„Ø¹Ø§Ø¨</a>
        <a class="drawer-item" href="#">Ø´Ø¨ÙƒØ§Øª</a>
        <a class="drawer-item" href="#">ØªØ®Ø²ÙŠÙ†</a>
      </div>
    </div>
  </aside>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true">
    <div>
      <div class="t-title" id="toastTitle">ØªÙ…</div>
      <div class="t-msg" id="toastMsg">...</div>
    </div>
    <button class="t-x" type="button" id="toastClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
  </div>

  <!-- Bottom nav (mobile) -->
  <nav class="bottom-nav" aria-label="ØªÙ†Ù‚Ù„ Ø³ÙÙ„ÙŠ">
    <div class="bottom-row">
      <a class="b-item" href="{% url 'orders:home' %}">
        <span class="b-ico">ğŸ </span>
        <span class="b-txt">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
      </a>

      <button class="b-item" type="button" id="mobileCatsBtn" style="border:0;background:transparent;cursor:pointer;">
        <span class="b-ico">â˜°</span>
        <span class="b-txt">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
      </button>

      <button class="b-item" type="button" id="mobileFavBtn" style="border:0;background:transparent;cursor:pointer;">
        <span class="b-ico">â¤</span>
        <span class="b-txt">Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
      </button>

      <a class="b-item" href="{% url 'orders:cart_detail' %}">
        <span class="b-ico">ğŸ›’</span>
        <span class="b-txt">Ø§Ù„Ø³Ù„Ø©</span>
      </a>
    </div>
  </nav>

</header>

<script>
  (function(){
    const header = document.getElementById('mainHeader');

    // drawer
    const drawerBtn = document.getElementById('catsDrawerBtn');
    const mobileCatsBtn = document.getElementById('mobileCatsBtn');
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('drawerBackdrop');
    const drawerClose = document.getElementById('drawerClose');

    // actions
    const cartBadge = document.getElementById('cartCountBadge');
    const favBtn = document.getElementById('favBtn');
    const favCount = document.getElementById('favCount');
    const mobileFavBtn = document.getElementById('mobileFavBtn');

    // toast
    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMsg = document.getElementById('toastMsg');
    const toastClose = document.getElementById('toastClose');
    let toastTimer = null;

    function safeInt(v){
      const n = parseInt(v, 10);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    }

    function toastShow(title, msg){
      if(!toast) return;
      toastTitle.textContent = title || 'ØªÙ†Ø¨ÙŠÙ‡';
      toastMsg.textContent = msg || '';
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 2200);
    }
    window.appToast = toastShow;

    if(toastClose){
      toastClose.addEventListener('click', () => toast.classList.remove('show'));
    }

    function onScroll(){
      if(!header) return;
      header.classList.toggle('is-scrolled', window.scrollY > 8);
    }
    window.addEventListener('scroll', onScroll, {passive:true});
    onScroll();

    // ===== Drawer open/close =====
    function openDrawer(){
      if(!drawer || !backdrop) return;
      drawer.classList.add('show');
      drawer.setAttribute('aria-hidden','false');
      backdrop.hidden = false;
      backdrop.classList.add('show');
      document.documentElement.style.overflow = 'hidden';
    }
    function closeDrawer(){
      if(!drawer || !backdrop) return;
      drawer.classList.remove('show');
      drawer.setAttribute('aria-hidden','true');
      backdrop.classList.remove('show');
      setTimeout(()=>{ backdrop.hidden = true; }, 180);
      document.documentElement.style.overflow = '';
    }

    if(drawerBtn) drawerBtn.addEventListener('click', openDrawer);
    if(mobileCatsBtn) mobileCatsBtn.addEventListener('click', openDrawer);
    if(drawerClose) drawerClose.addEventListener('click', closeDrawer);
    if(backdrop) backdrop.addEventListener('click', closeDrawer);
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeDrawer(); });

    // ===== Search =====
    const searchForm = document.getElementById('searchForm');
    if(searchForm){
      searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const q = document.getElementById('q')?.value?.trim();
        if(!q) return toastShow('Ø§Ù„Ø¨Ø­Ø«', 'Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹');
        toastShow('Ø§Ù„Ø¨Ø­Ø«', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: ' + q);
      });
    }

    // ===== cart summary from server =====
    async function fetchCartCount(){
      const url = "{% url 'orders:cart_summary' %}";
      try{
        const res = await fetch(url, {
          method: 'GET',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await res.json();
        if(!res.ok || !data || data.ok !== true) return null;
        return safeInt(data.cart_count);
      }catch(_){
        return null;
      }
    }
    async function syncCartFromServer(){
      if(!cartBadge) return;
      const count = await fetchCartCount();
      if(count === null) return;
      cartBadge.textContent = String(count);
    }

    // ===== Favorites (demo localStorage) =====
    function syncFavBadge(){
      if(favCount) favCount.textContent = String(safeInt(localStorage.getItem('fav_count')));
    }

    syncFavBadge();
    syncCartFromServer();

    window.addEventListener('cart:updated', (e) => {
      const count = e && e.detail && typeof e.detail.count !== 'undefined' ? safeInt(e.detail.count) : null;
      if(count !== null && cartBadge){
        cartBadge.textContent = String(count);
      }else{
        syncCartFromServer();
      }
    });

    window.addEventListener('fav:updated', syncFavBadge);
    window.addEventListener('storage', (e)=>{
      if(e.key === 'fav_count') syncFavBadge();
    });

    function toggleFav(){
      const cur = safeInt(localStorage.getItem('fav_count'));
      const next = cur === 0 ? 1 : 0;
      localStorage.setItem('fav_count', String(next));
      if(favBtn) favBtn.setAttribute('aria-pressed', next > 0 ? 'true' : 'false');
      syncFavBadge();
      toastShow('Ø§Ù„Ù…ÙØ¶Ù„Ø©', next > 0 ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…' : 'ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø©');
      window.dispatchEvent(new Event('fav:updated'));
    }

    if(favBtn) favBtn.addEventListener('click', toggleFav);
    if(mobileFavBtn) mobileFavBtn.addEventListener('click', toggleFav);

    // ===== Actions demo handling (Ù„Ø§ ØªÙ…Ù†Ø¹ cart/login/signup) =====
    document.querySelectorAll('[data-action]').forEach(el=>{
      el.addEventListener('click',(e)=>{
        const a = el.getAttribute('data-action') || '';
        if(a !== 'cart' && a !== 'login' && a !== 'signup'){
          e.preventDefault();
          toastShow('ØªÙ†Ø¨ÙŠÙ‡', 'Ø²Ø± ('+a+') Ø¬Ø§Ù‡Ø² â€” Ø§Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø¨Ø§ÙƒÙ†Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹');
        }
      });
    });

    // Ù„Ø§ ØªÙ…Ù†Ø¹ ØªÙ†Ù‚Ù‘Ù„ ØµÙØ­Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    function forceNavigate(selector){
      const el = document.querySelector(selector);
      if(!el) return;
      el.addEventListener('click', function(e){
        const href = (this.getAttribute('href') || '').trim();
        if(!href || href === '#') return;
        e.stopPropagation();
      }, true);
    }
    forceNavigate('[data-action="login"]');
    forceNavigate('[data-action="signup"]');
  })();
</script>
